function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function InitAdapter(){return{}}function apiCall(t,l){if(!Ti.Network.online)return Alloy.Globals.core.offlineModal||Alloy.Globals.core.createOfflineModal(),Alloy.Globals.core.offlineModal.show(),void l({success:!1,status:"offline",responseText:null});var e=t.cache||!1,o=!1;e&&(Alloy.Globals.caches[e.name]||(Alloy.Globals.caches[e.name]={data:!1,expires:new Date+6e4*e.validMinutes,valid:function(){return this.data?new Date>this.expires?!1:!0:!1},save:function(t){this.data=t,this.expires=new Date+6e4*e.validMinutes}}),o=Alloy.Globals.caches[e.name]);var i=Ti.Network.createHTTPClient({timeout:t.timeout||15e3});if(o&&o.valid())return Ti.API.info("[REST API] RETURN FROM CACHE "+e.name),void l({success:!0,status:"ok",code:200,responseJSON:o.data});var s="?";if(t.data&&"GET"==t.type){for(var r in t.data)s+=r+"="+t.data[r]+"&";s=s.substr(0,s.length-1),t.url+=s}i.open(t.type,t.url),Ti.API.info("[xhr.open(_options.type, _options.url)]"),Ti.API.info(t);var a=new Benchmark;for(var n in t.headers)i.setRequestHeader(n,t.headers[n]);t.beforeSend&&t.beforeSend(i),i.send("GET"==t.type?null:t.data||null),i.onload=function(){var t,s,r=!0;try{i.responseText&&(t=JSON.parse(i.responseText))}catch(n){Ti.API.error("[REST API] apiCall ERROR: "+n.message),r=!1,s=n.message}o&&(o.save(t),Ti.API.info("[REST API] SAVED TO CACHE "+e.name)),Alloy.Globals.core.hideWait(),Ti.API.info("Time - "+a.test()+" ms"),l({success:r,status:r?200==i.status?"ok":i.status:"error",code:i.status,data:s,responseText:i.responseText||null,responseJSON:t||null})},i.onerror=function(t){var e;try{e=JSON.parse(i.responseText)}catch(t){}Alloy.Globals.core.hideWait(),"-1001"==t.code&&Alloy.Globals.core.showErrorDialog(L("internet_weak")),l({success:!1,status:"error",code:i.status,data:t.error,responseText:i.responseText,responseJSON:e||null}),Ti.API.error("[REST API] apiCall ERROR: "+i.responseText),Ti.API.error("[REST API] apiCall ERROR CODE: "+i.status),Ti.API.error("XHR]: "+i)}}function Sync(t,l,e){var o=l.config.debug;l.config.URL&&l.config.URL.indexOf("{apiToken}")>0&&(l.config.URL=l.config.URL.replace("{apiToken}",Alloy.Globals.core.apiToken())),l.idAttribute=l.config.adapter.idAttribute||"id";var i=l.config.parentNode,s={create:"POST",read:"GET",update:"PUT","delete":"DELETE"},r=s[t],a=_.extend({},e);if(a.type=r,l.config.type&&(a.type=l.config.type),a.headers=a.headers||{},l.config.hasOwnProperty("headers"))for(var n in l.config.headers)a.headers[n]=l.config.headers[n];if(!a.url&&(a.url=l.config.URL||l.url(),!a.url))return Ti.API.error("[REST API] ERROR: NO BASE URL"),void(l.config.URL=l.config.URL.replace(Alloy.Globals.core.apiToken(),"{apiToken}"));switch(Alloy.Backbone.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.processData=!0,a.data=a.data?{model:a.data}:{}),!Alloy.Backbone.emulateHTTP||"PUT"!==r&&"DELETE"!==r||(Alloy.Backbone.emulateJSON&&(a.data._method=r),a.type="POST",a.beforeSend=function(){a.headers["X-HTTP-Method-Override"]=r}),a.headers["Content-Type"]="application/json",logger(o,"REST METHOD",t),t){case"create":a.data=JSON.stringify(l.toJSON()),logger(o,"create options",a),apiCall(a,function(t){if(t.success){var e=parseJSON(o,t,i);e&&void 0===e[l.idAttribute]&&(e[l.idAttribute]=guid()),a.success(e,JSON.stringify(e)),l.trigger("fetch")}else a.error(t.responseJSON,t.responseText),Ti.API.error("[REST API] CREATE ERROR: "),Ti.API.error(t)});break;case"read":l[l.idAttribute]&&(a.url=a.url+"/"+l[l.idAttribute]),a.urlparams&&(a.url=encodeData(a.urlparams,a.url)),logger(o,"read options",a),apiCall(a,function(t){if(t.success){var e=parseJSON(o,t,i),s=[];l.length=0;for(var r in e){var n={};n=e[r],n&&void 0===n[l.idAttribute]&&(n[l.idAttribute]=guid()),s.push(n),l.length++}a.success(1===l.length?s[0]:s,t.responseText),l.trigger("fetch")}else a.error(t.responseJSON,t.responseText),Ti.API.error("[REST API] READ ERROR: "),Ti.API.error(t)});break;case"update":if(!l.get(l.idAttribute))return a.error(null,"MISSING MODEL ID"),Ti.API.error("[REST API] ERROR: MISSING MODEL ID"),void(l.config.URL=l.config.URL.replace(Alloy.Globals.core.apiToken(),"{apiToken}"));if(-1==_.indexOf(a.url,"?"))a.url=a.url+"/"+l[l.idAttribute];else{var y=a.url.split("?");a.url=y[0]+"/"+l[l.idAttribute]+"?"+y[1]}a.urlparams&&(a.url=encodeData(a.urlparams,a.url)),a.data=JSON.stringify(l.toJSON()),logger(o,"update options",a),apiCall(a,function(t){if(t.success){var e=parseJSON(o,t,i);a.success(e,JSON.stringify(e)),l.trigger("fetch")}else a.error(t.responseJSON,t.responseText),Ti.API.error("[REST API] UPDATE ERROR: "),Ti.API.error(t)});break;case"delete":if(!l[l.idAttribute])return a.error(null,"MISSING MODEL ID"),Ti.API.error("[REST API] ERROR: MISSING MODEL ID"),void(l.config.URL=l.config.URL.replace(Alloy.Globals.core.apiToken(),"{apiToken}"));a.url=a.url+"/"+l[l.idAttribute],logger(o,"delete options",a),apiCall(a,function(t){t.success?(parseJSON(o,t,i),a.success(null,t.responseText),l.trigger("fetch")):(a.error(t.responseJSON,t.responseText),Ti.API.error("[REST API] DELETE ERROR: "),Ti.API.error(t))})}Alloy.Globals.core.apiToken()&&(l.config.URL=l.config.URL.replace(Alloy.Globals.core.apiToken(),"{apiToken}"))}function logger(t,l,e){t&&(Ti.API.debug("[REST API] "+l),Ti.API.debug("object"==typeof e?JSON.stringify(e,null,"	"):e))}function parseJSON(t,l,e){var o=l.responseJSON;return _.isUndefined(e)||(o=_.isFunction(e)?e(o):traverseProperties(o,e)),logger(t,"server response",l),o}function traverseProperties(t,e){var o=e.split(".");for(i=0,l=o.length;l>i;i++)t=t[o[i]];return t}function encodeData(t,l){var e=[];for(var o in t)e.push(Ti.Network.encodeURIComponent(o)+"="+Ti.Network.encodeURIComponent(t[o]));return-1==_.indexOf(l,"?")?l+"?"+e.join("&"):l+"&"+e.join("&")}var modal;Ti.Network.addEventListener("change",function(t){if(t.online){var l=Alloy.Globals.core.apiToken();l&&(Alloy.Globals.chat.connected||Alloy.Globals.chat.openConnect())}else Alloy.Globals.core.offlineModal||Alloy.Globals.core.createOfflineModal(),Alloy.Globals.core.offlineModal.show()});var _=require("alloy/underscore")._,Alloy=require("alloy"),Backbone=Alloy.Backbone;module.exports.sync=Sync,module.exports.beforeModelCreate=function(t){return t=t||{},InitAdapter(t),t},module.exports.afterModelCreate=function(t){return t=t||{},t.prototype.config.Model=t,t.prototype.idAttribute=t.prototype.config.adapter.idAttribute,t};
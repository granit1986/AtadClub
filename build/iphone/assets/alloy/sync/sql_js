function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(t,l){this.db=l,this.dbname=t.adapter.db_name,this.table=t.adapter.collection_name,this.idAttribute=t.adapter.idAttribute,this.column=function(t){var l=t.split(/\s+/),e=l[0];switch(e.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+e+'" is not a valid sqlite field, using TEXT instead');case"text":e="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+e+'" is not a valid sqlite field, using INTEGER instead');case"integer":e="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+t+'" is not a valid sqlite field, using REAL instead');case"real":e="REAL";break;case"blob":e="BLOB";break;case"null":e="NULL";break;default:e="TEXT"}return l[0]=e,l.join(" ")},this.createTable=function(t){var l=[],e=!1;for(var o in t.columns)o===this.idAttribute&&(e=!0),l.push(o+" "+this.column(t.columns[o]));e||this.idAttribute!==ALLOY_ID_DEFAULT||l.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var i="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+l.join(",")+")";this.db.execute(i)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(t){var l=[],e=[],o=[],i=!1;for(var s in t)s===this.idAttribute&&(i=!0),l.push(s),e.push(t[s]),o.push("?");i||this.idAttribute!==ALLOY_ID_DEFAULT||(l.push(this.idAttribute),e.push(guid()),o.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+l.join(",")+") VALUES ("+o.join(",")+");",e)},this.deleteRow=function(t){var l="DELETE FROM "+this.table,e=_.keys(t),o=e.length,i=[],s=[];o&&(l+=" WHERE ");for(var r=0;o>r;r++)i.push(e[r]+" = ?"),s.push(t[e[r]]);l+=i.join(" AND "),this.db.execute(l,s)}}function Sync(t,l,e){var o,i,s=l.config.adapter.collection_name,r=l.config.columns,a=l.config.adapter.db_name||ALLOY_DB_DEFAULT,n=null;switch(t){case"create":case"update":n=function(){var t={};l.id||(l.id=l.idAttribute===ALLOY_ID_DEFAULT?guid():null,t[l.idAttribute]=l.id,l.set(t,{silent:!0}));var e=[],n=[],y=[];for(var d in r)e.push(d),n.push(l.get(d)),y.push("?");if(i="REPLACE INTO "+s+" ("+e.join(",")+") VALUES ("+y.join(",")+");",o=Ti.Database.open(a),o.execute("BEGIN;"),o.execute(i,n),null===l.id){var p="SELECT last_insert_rowid();",c=o.execute(p);c&&c.isValidRow()?(l.id=c.field(0),t[l.idAttribute]=l.id,l.set(t,{silent:!0})):Ti.API.warn("Unable to get ID from database for model: "+l.toJSON()),c&&c.close()}return o.execute("COMMIT;"),o.close(),l.toJSON()}();break;case"read":e.query&&e.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),i="SELECT * FROM "+s,e.query?i=e.query:e.id&&(i+=" WHERE "+(l.idAttribute?l.idAttribute:ALLOY_ID_DEFAULT)+" = "+(_.isString(e.id)?'"'+e.id+'"':e.id)),o=Ti.Database.open(a);var y;y=_.isString(i)?o.execute(i):o.execute(i.statement,i.params);for(var d=0,p=[];y.isValidRow();){var c={},g=0;g=_.isFunction(y.fieldCount)?y.fieldCount():y.fieldCount,_.times(g,function(t){var l=y.fieldName(t);c[l]=y.fieldByName(l)}),p.push(c),d++,y.next()}y.close(),o.close(),l.length=d,n=1===d?p[0]:p;break;case"delete":i="DELETE FROM "+s+" WHERE "+l.idAttribute+"=?",o=Ti.Database.open(a),o.execute(i,l.id),o.close(),l.id=null,n=l.toJSON()}n?(_.isFunction(e.success)&&e.success(n),"read"!==t||e.silent||l.trigger("fetch",{fromAdapter:!0})):_.isFunction(e.error)&&e.error(n)}function GetMigrationFor(t,l){var e=null,o=Ti.Database.open(t);o.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var i=o.execute("SELECT latest FROM migrations where model = ?;",l);return i.isValidRow()&&(e=i.field(0)+""),i.close(),o.close(),e}function Migrate(t){var l=t.migrations||[],e={};l.length&&l[l.length-1](e);var o=t.prototype.config;o.adapter.db_name=o.adapter.db_name||ALLOY_DB_DEFAULT;var i=new Migrator(o),s="undefined"==typeof o.adapter.migration||null===o.adapter.migration?e.id:o.adapter.migration;if("undefined"==typeof s||null===s){var r=Ti.Database.open(o.adapter.db_name);return i.db=r,i.createTable(o),void r.close()}s+="";var a,n=GetMigrationFor(o.adapter.db_name,o.adapter.collection_name);if(n!==s){if(n&&n>s?(a=0,l.reverse()):a=1,db=Ti.Database.open(o.adapter.db_name),i.db=db,db.execute("BEGIN;"),l.length)for(var y=0;y<l.length;y++){var d=l[y],p={};if(d(p),a){if(p.id>s)break;if(p.id<=n)continue}else{if(p.id<=s)break;if(p.id>n)continue}var c=a?"up":"down";_.isFunction(p[c])&&p[c](i)}else i.createTable(o);db.execute("DELETE FROM migrations where model = ?",o.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",s,o.adapter.collection_name),db.execute("COMMIT;"),db.close(),i.db=null}}function installDatabase(t){var l=t.adapter.db_file,e=t.adapter.collection_name,o=/(^|.*\/)([^\/]+)\.[^\/]+$/,i=l.match(o);if(null===i)throw'Invalid sql database filename "'+l+'"';t.adapter.db_name=t.adapter.db_name||i[2];var s=t.adapter.db_name;Ti.API.debug('Installing sql database "'+l+'" with name "'+s+'"');var r=Ti.Database.install(l,s);!1===t.adapter.remoteBackup&&(Ti.API.debug('iCloud "do not backup" flag set for database "'+l+'"'),r.file.setRemoteBackup(!1));var a,n,y=r.execute('pragma table_info("'+e+'");'),d={};if(y){for(;y.isValidRow();)a=y.fieldByName("name"),n=y.fieldByName("type"),d[a]=n,a!==ALLOY_ID_DEFAULT||t.adapter.idAttribute||(t.adapter.idAttribute=ALLOY_ID_DEFAULT),y.next();y.close()}else{t.adapter.idAttribute?t.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var p in t.columns)a=p,n=t.columns[p],a!==ALLOY_ID_DEFAULT||t.adapter.idAttribute?p===t.adapter.idAttribute&&(n+=" UNIQUE"):t.adapter.idAttribute=ALLOY_ID_DEFAULT,d[a]=n}if(t.columns=d,t.adapter.idAttribute){if(!_.contains(_.keys(t.columns),t.adapter.idAttribute))throw'config.adapter.idAttribute "'+t.adapter.idAttribute+'" not found in list of columns for table "'+e+'"\ncolumns: ['+_.keys(t.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+e+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var c=[],g=[];_.each(t.columns,function(t,l){g.push(l),c.push(l+" "+t)});var b=g.join(",");r.execute("ALTER TABLE "+e+" RENAME TO "+e+"_temp;"),r.execute("CREATE TABLE "+e+"("+c.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),r.execute("INSERT INTO "+e+"("+b+","+ALLOY_ID_DEFAULT+") SELECT "+b+",CAST(_ROWID_ AS TEXT) FROM "+e+"_temp;"),r.execute("DROP TABLE "+e+"_temp;"),t.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",t.adapter.idAttribute=ALLOY_ID_DEFAULT}r.close()}var _=require("alloy/underscore")._,ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(t,l){if(cache.config[l])return cache.config[l];if("mobileweb"===Ti.Platform.osname||"undefined"==typeof Ti.Database)throw"No support for Titanium.Database in MobileWeb environment.";return t.adapter.db_file&&installDatabase(t),t.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+t.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),t.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",t.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[l]=t,t},module.exports.afterModelCreate=function(t,l){return cache.Model[l]?cache.Model[l]:(t=t||{},t.prototype.idAttribute=t.prototype.config.adapter.idAttribute,Migrate(t),cache.Model[l]=t,t)},module.exports.sync=Sync;
function __processArg(e,t){var n=null;return e&&(n=e[t]||null,delete e[t]),n}function Controller(){function e(e){"answer"!==e.source.id&&f.answer.blur()}function t(){Alloy.Globals.chat.openChatId=!1}function n(){Alloy.Globals.chat.openChatId=v}function i(e){e.source.backgroundColor=Alloy.Globals.Styles.buttonBgOnTap}function o(e){e.source.backgroundColor=Alloy.Globals.Styles.buttonBg;var t=e.source.id;switch(t){case"send":c()}}function r(){Alloy.Globals.chat.openChatId=v,Alloy.Globals.chat.messagesWindow=f.messages,Alloy.Globals.chat.items=[],m||(E=Ti.UI.createRefreshControl({style:Ti.UI.iPhone.ActivityIndicatorStyle.PLAIN}),E.addEventListener("refreshstart",l),f.messages.refreshControl=E,T.openIndicator(),a()),Alloy.Globals.chat.connected||(Alloy.Globals.chat.openConnect(),Alloy.Globals.core.showErrorDialog(L("chat_server_unavailable")))}function a(){k=!0,y.fetch({data:{chatId:v,offset:I,length:S},success:function(){k=!1,s(y.toJSON()),I||h()},error:function(){k=!1,T.closeIndicator(),E.endRefreshing()}})}function s(e){var t=Alloy.Globals.chat.addMessage(e);f.messages.setData(t),E.endRefreshing()}function l(){I=Alloy.Globals.chat.items.length,a()}function c(){Alloy.Globals.chat.openChatId=v;var e={text:f.answer.value,toUserId:w,ChatId:v,fromUserId:Alloy.Globals.profile.id};Ti.Network.online?Alloy.Globals.chat.connected?d(e):(Alloy.Globals.chat.notSendedMessage=JSON.stringify(e),Alloy.Globals.chat.openConnect(),f.answer.value="",Alloy.Globals.core.showErrorDialog(L("error_send_message"))):Alloy.Globals.core.showErrorDialog(L("no_connection"))}function d(e){Alloy.Globals.chat.source.send(JSON.stringify(e)),f.answer.value="",f.answer.height=Ti.UI.SIZE,A=f.form.size.height,f.messages.bottom=A,h(),f.answer.blur()}function u(){Alloy.Globals.chat.openChatId=!1,Alloy.Collections.messages=Alloy.createCollection("message"),Alloy.Collections.chats.fetch({success:function(){},error:function(){}})}function h(){f.messages.data[0]&&f.messages.scrollToIndex(f.messages.data[0].rows.length-1),T.closeIndicator()}require("alloy/controllers/BaseController").apply(this,Array.prototype.slice.call(arguments)),this.__controllerPath="account/answers/answer",arguments[0]&&(__processArg(arguments[0],"__parentSymbol"),__processArg(arguments[0],"$model"),__processArg(arguments[0],"__itemTemplate"));var f=this,p={},g={};f.__views.window=Ti.UI.createWindow({backgroundImage:Alloy.Globals.Styles.backgroundImage,layout:"absolute",height:Ti.UI.FILL,fullscreen:"true",id:"window",titleid:"offer"}),f.__views.window&&f.addTopLevelView(f.__views.window),u?f.__views.window.addEventListener("close",u):g["$.__views.window!close!close"]=!0,r?f.__views.window.addEventListener("open",r):g["$.__views.window!open!open"]=!0,t?f.__views.window.addEventListener("blur",t):g["$.__views.window!blur!blur"]=!0,n?f.__views.window.addEventListener("focus",n):g["$.__views.window!focus!focus"]=!0,e?f.__views.window.addEventListener("click",e):g["$.__views.window!click!click"]=!0,f.__views.messages=Ti.UI.createTableView({backgroundColor:"transparent",width:Ti.UI.FILL,top:"3dp",bottom:"50dp",id:"messages",separatorColor:"transparent"}),f.__views.window.add(f.__views.messages),f.__views.form=Ti.UI.createView({height:Ti.UI.SIZE,width:Ti.UI.FILL,bottom:0,backgroundColor:"#eee",id:"form"}),f.__views.window.add(f.__views.form),f.__views.answer=Ti.UI.createTextArea(function(){var e={};return Alloy.Globals.isHe&&_.extend(e,{textAlign:"right"}),_.extend(e,{height:Ti.UI.SIZE,width:"200dp",left:"10dp",top:"10dp",bottom:"10dp",textAlign:Alloy.Globals.Styles.inputTextAlign,font:{fontSize:"15dp",fontFamily:"Arial"},backgroundColor:"#fff",color:Alloy.Globals.Styles.inputColor,id:"answer"}),e}()),f.__views.form.add(f.__views.answer),f.__views.send=Ti.UI.createButton({width:"90dp",height:"32dp",right:"10dp",bottom:"10dp",style:Titanium.UI.iPhone.SystemButtonStyle.PLAIN,font:{fontFamily:"Avenir Next Condensed",fontSize:"18dp"},color:"#fff",textAlign:"center",verticalAlign:"center",backgroundColor:Alloy.Globals.Styles.buttonBg,id:"send",titleid:"send"}),f.__views.form.add(f.__views.send),i?f.__views.send.addEventListener("touchstart",i):g["$.__views.send!touchstart!buttonTouchStart"]=!0,o?f.__views.send.addEventListener("touchend",o):g["$.__views.send!touchend!buttonTouchEnd"]=!0,p.destroy=function(){},_.extend(f,f.__views);var m=arguments[0].newChat||!1,y=Alloy.createCollection("message"),v=arguments[0].id,w=arguments[0].toUser,b=arguments[0].UserName;f.window.title=b;var A=f.form.size.height,T=Alloy.Globals.indicator,I=0,S=10,k=!1,E=!1;f.answer.addEventListener("focus",function(){A=f.form.size.height,f.form.animate({bottom:166,duration:500}),f.messages.animate({bottom:166+A,duration:500}),h()}),f.answer.addEventListener("change",function(){A!=f.form.size.height&&(A=f.form.size.height,f.form.animate({bottom:166,duration:500}),f.messages.bottom=166+A,h())}),f.answer.addEventListener("blur",function(){f.form.animate({bottom:0,duration:500}),f.messages.animate({bottom:A,duration:500}),h()}),f.answer.addEventListener("return",function(){f.answer.size.height>150&&(f.answer.height=150),A=f.form.size.height,f.messages.animate({bottom:A,duration:500}),h()}),g["$.__views.window!close!close"]&&f.__views.window.addEventListener("close",u),g["$.__views.window!open!open"]&&f.__views.window.addEventListener("open",r),g["$.__views.window!blur!blur"]&&f.__views.window.addEventListener("blur",t),g["$.__views.window!focus!focus"]&&f.__views.window.addEventListener("focus",n),g["$.__views.window!click!click"]&&f.__views.window.addEventListener("click",e),g["$.__views.send!touchstart!buttonTouchStart"]&&f.__views.send.addEventListener("touchstart",i),g["$.__views.send!touchend!buttonTouchEnd"]&&f.__views.send.addEventListener("touchend",o),_.extend(f,p)}var Alloy=require("alloy"),Backbone=Alloy.Backbone,_=Alloy._;module.exports=Controller;
function __processArg(e,t){var l=null;return e&&(l=e[t]||null,delete e[t]),l}function Controller(){function e(e){return f?!1:k==e.index?!1:(f=!0,b=0,k=e.index,a.is.state(1),C.sort=k,C.offset=b,void t(C))}function t(e){Alloy.Collections.publicAdverts.fetch({data:e,success:function(e,t){if(Object.size(t)>0){var l=new Array;l.push(t),t=l}t&&t.length>0&&(b=Alloy.Collections.publicAdverts.length,a.window.setRightNavButton(m),i(),f=!1,Alloy.Globals.core.createRows(Alloy.Collections.publicAdverts,s,a.adverts,"home/adverts/row"),a.sortsLbl.visible="true",a.sorts.visible="true",a.adverts.visible="true")},error:function(e,l){if(f=!1,l){var o,i;switch(l.Message){case"-1":i=-1,o="no_adverts_in_subcategories";break;case"-2":i=-2,o="no_adverts_in_you_location"}var s=Titanium.UI.createAlertDialog({title:L("no_adverts_found"),message:L(o),buttonNames:[L("no"),L("yes")],cancel:0});s.addEventListener("click",function(e){if(e.cancel===e.index||!0===e.cancel)return void a.window.close();switch(i){case-1:C={length:g,offset:0,subCategories:"[]",distance:h,lat:I,lng:T},x=!0,t(C);break;case-2:C={length:g,offset:0,subCategories:"[]",distance:-1,lat:I,lng:T},t(C),x=!0}}),s.show()}}})}function l(){Alloy.Collections.publicAdverts.reset()}function o(e){return f?(e.success(),!1):(f=!0,x?C.offset=b:C={lng:T,lat:I,length:g,offset:b,distance:h,subCategories:JSON.stringify(w),sort:k},void Alloy.Collections.publicAdverts.fetch({silent:!0,data:C,add:!0,success:function(t,l){return f=!1,l.length?(Alloy.Globals.core.createRows(Alloy.Collections.publicAdverts,s,a.adverts,"home/adverts/row"),b+=l.length,l.length<g?e.done():e.success(),void i()):void e.done()},error:function(){e.done(),f=!1}}))}function i(){G=[];var e=Alloy.Collections.publicAdverts.models;d=999,c=-999,u=999,y=-999;for(var t in e){var l=e[t],o=parseFloat(l.attributes.lat),i=parseFloat(l.attributes.lng);o>c&&(c=o),d>o&&(d=o),i>y&&(y=i),u>i&&(u=i),G.push(p.createAnnotation({latitude:o,longitude:i,title:l.attributes.name,subtitle:l.attributes.address,pincolor:Alloy.Globals.Map.ANNOTATION_RED,rightButton:Ti.UI.iPhone.SystemButton.DISCLOSURE,advertId:l.attributes.id}))}}function s(e){var t=e.toJSON();return t.distance=-1==t.distance?"--":t.distance.toFixed(2)+" km",t.images=t.images&&t.images.length>0?JSON.parse(t.images):[],t.images.length>0&&(t.image=-1!=t.images[0]?"http://"+Ti.App.serverDomain+"/api/"+Titanium.App.ApiVersion+"/image/"+t.images[0]+Alloy.Globals.imageSizes.advert.row():"appicon-72.png"),t.price=t.currency+" "+t.price,t}require("alloy/controllers/BaseController").apply(this,Array.prototype.slice.call(arguments)),this.__controllerPath="home/adverts/index",arguments[0]&&(__processArg(arguments[0],"__parentSymbol"),__processArg(arguments[0],"$model"),__processArg(arguments[0],"__itemTemplate"));var a=this,r={},n={};a.__views.window=Ti.UI.createWindow({backgroundImage:Alloy.Globals.Styles.backgroundImage,layout:"horizontal",fullscreen:"true",id:"window",titleid:"advers"}),a.__views.window&&a.addTopLevelView(a.__views.window),l?a.__views.window.addEventListener("close",l):n["$.__views.window!close!close"]=!0,a.__views.wrapper=Ti.UI.createView({id:"wrapper"}),a.__views.window.add(a.__views.wrapper),a.__views.sortsLbl=Ti.UI.createLabel(function(){var e={};return _.extend(e,{width:"80dp",height:"30dp",color:"#007aff",left:Alloy.Globals.Styles.labelLeft,right:"60dp",textAlign:Alloy.Globals.Styles.labelTextAlign,font:{fontSize:"15dp",fontFamily:"Avenir Next Condensed"}}),Alloy.Globals.isHebrew&&_.extend(e,{left:Alloy.Globals.Styles.row_statusWrapLeft,right:Alloy.Globals.Styles.row_statusWrapRight}),_.extend(e,{top:"10dp",id:"sortsLbl",textid:"sort_by",visible:"false"}),e}()),a.__views.wrapper.add(a.__views.sortsLbl),a.__views.sorts=Ti.UI.iOS.createTabbedBar({top:"10dp",left:"110dp",height:"30dp",style:Ti.UI.iPhone.SystemButtonStyle.BAR,backgroundColor:"#007aff",font:{fontSize:"12dp",fontFamily:"Avenir Next Condensed"},id:"sorts",index:"0",visible:"false"}),a.__views.wrapper.add(a.__views.sorts),e?a.__views.sorts.addEventListener("click",e):n["$.__views.sorts!click!Sort"]=!0,a.__views.is=Alloy.createWidget("nl.fokkezb.infiniteScroll","widget",{id:"is"}),o?a.__views.is.on("end",o):n["$.__views.is!end!add"]=!0,a.__views.adverts=Ti.UI.createTableView({backgroundColor:"#00ffffff",layout:"vertical",top:"40dp",bottom:"5dp",footerView:a.__views.is.getProxyPropertyEx("footerView",{recurse:!0}),id:"adverts",visible:"false"}),a.__views.wrapper.add(a.__views.adverts),r.destroy=function(){},_.extend(a,a.__views);var d,c,u,y,p=require("ti.map"),b=(Alloy.Globals.geo,0),g=10,h=arguments[0].distance,w=arguments[0].subCategories,f=!1,v=!0,A=!1,m=Ti.UI.createButton({titleid:"map"}),S=Alloy.createController("home/adverts/map").getView(),I=(Alloy.Globals.geo,arguments[0].lat),T=arguments[0].lng,G=[],C={},x=!1;a.window.setTitle(L("adverts")),a.sorts.labels=[L("distance"),L("price")];var k=0;m.addEventListener("click",function(){return A?!1:(A=!0,void(v?(S.annotations=G,Alloy.Globals.mapRegion={latitude:(d+c)/2,longitude:(u+y)/2,latitudeDelta:2*(c-d),longitudeDelta:2*(y-u)},S.region=Alloy.Globals.mapRegion,a.wrapper.animate({view:S,transition:Ti.UI.iPhone.AnimationStyle.FLIP_FROM_LEFT},function(){a.window.setTitle(L("map")),m.setTitle(L("list")),v=!1,A=!1})):a.wrapper.animate({view:a.adverts,transition:Ti.UI.iPhone.AnimationStyle.FLIP_FROM_RIGHT},function(){a.window.setTitle(L("adverts")),m.setTitle(L("map")),v=!0,A=!1})))}),C={length:g,offset:0,distance:h,lat:I,lng:T,subCategories:JSON.stringify(w),sort:k},t(C),n["$.__views.window!close!close"]&&a.__views.window.addEventListener("close",l),n["$.__views.sorts!click!Sort"]&&a.__views.sorts.addEventListener("click",e),n["$.__views.is!end!add"]&&a.__views.is.on("end",o),_.extend(a,r)}var Alloy=require("alloy"),Backbone=Alloy.Backbone,_=Alloy._;module.exports=Controller;
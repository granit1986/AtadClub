function __processArg(e,t){var l=null;return e&&(l=e[t]||null,delete e[t]),l}function Controller(){function e(){a()}function t(e){var t=e.toJSON();return t.price=t.currency+" "+t.price,t.images=t.images&&t.images.length>0?JSON.parse(t.images):[],t.distance=parseFloat(t.distance).toFixed(2)+" km",t.myLat=w,t.myLng=g,t.dealtype=Alloy.Globals.core.dealType[t.dealtype].title,t.endTime&&(t.endTime=Alloy.Globals.core.viewTime(Alloy.Globals.core.createTime(t.endTime))),t.images.length>0&&(t.image="http://"+Ti.App.serverDomain+"/api/"+Titanium.App.ApiVersion+"/image/"+t.images[0]+Alloy.Globals.imageSizes.deal.row()),h++,t}function l(e){var l=new Benchmark;f.openIndicator(),I=!0;var o=Alloy.Globals.core.apiToken(),i=new Date;S.fetch({add:!0,silent:!0,data:{offset:S.length,sort:y,lat:w,lng:g,distance:distance,token:o,clientTimeZoneOffset:i.getTimezoneOffset(),subcategories:b},success:function(o,i){return I=!1,f.closeIndicator(),i.length?(Alloy.Globals.core.createRows(S,t,n.deals,"home/deals/row"),Ti.API.info("Update time - "+l.test()+" ms"),Ti.API.info(h),h=0,void(i.length<v?e.done():e.success())):(e.done(),void Ti.API.info("Update time - "+l.test()+" ms"))},error:function(){e.done(),I=!1,f.closeIndicator()}})}function o(e){return y==e.index+1?!1:(n.is.state(1),T=new m,y=e.index+1,void a())}function i(e){return I?void e.success():(I=!0,void l(e))}function a(){var e=new Benchmark;f.openIndicator();var l=Alloy.Globals.core.apiToken(),o=new Date;S.fetch({data:{sort:y,lat:w,lng:g,distance:distance,token:l,clientTimeZoneOffset:o.getTimezoneOffset(),subcategories:b},success:function(){Alloy.Globals.core.createRows(S,t,n.deals,"home/deals/row"),Ti.API.info("Fetch time - "+e.test()+" ms"),I=!1,f.closeIndicator(),Ti.API.info(h),h=0},error:function(){I=!1,f.closeIndicator()}})}function s(){Ti.App.removeEventListener("supplierWindow:blocked",r),S.reset()}function r(){A=0,S=Alloy.Collections.publicDeals,I=!0,T=new m,a()}require("alloy/controllers/BaseController").apply(this,Array.prototype.slice.call(arguments)),this.__controllerPath="home/deals/index",arguments[0]&&(__processArg(arguments[0],"__parentSymbol"),__processArg(arguments[0],"$model"),__processArg(arguments[0],"__itemTemplate"));var n=this,d={},c={};n.__views.window=Ti.UI.createWindow({backgroundImage:Alloy.Globals.Styles.backgroundImage,layout:"vertical",id:"window",fullscreen:"true",titleid:"search_result"}),n.__views.window&&n.addTopLevelView(n.__views.window),s?n.__views.window.addEventListener("close",s):c["$.__views.window!close!close"]=!0,e?n.__views.window.addEventListener("open",e):c["$.__views.window!open!open"]=!0,n.__views.wrapper=Ti.UI.createView({id:"wrapper"}),n.__views.window.add(n.__views.wrapper),n.__views.sortsLbl=Ti.UI.createLabel({width:"280dp",height:Alloy.Globals.Styles.labelHeight,color:Alloy.Globals.Styles.labelColor,left:"20dp",right:Alloy.Globals.Styles.labelRight,textAlign:"center",font:{fontSize:"17dp",fontFamily:"Avenir Next Condensed"},top:"10dp",id:"sortsLbl",textid:"sort_by"}),n.__views.wrapper.add(n.__views.sortsLbl),n.__views.sorts=Ti.UI.iOS.createTabbedBar({top:"40dp",left:"20dp",width:"280dp",height:"30dp",style:Ti.UI.iPhone.SystemButtonStyle.BAR,backgroundColor:"#007aff",font:{fontSize:"12dp",fontFamily:"Avenir Next Condensed"},id:"sorts",index:"0"}),n.__views.wrapper.add(n.__views.sorts),o?n.__views.sorts.addEventListener("click",o):c["$.__views.sorts!click!Sort"]=!0,n.__views.is=Alloy.createWidget("nl.fokkezb.infiniteScroll","widget",{id:"is"}),i?n.__views.is.on("end",i):c["$.__views.is!end!add"]=!0,n.__views.deals=Ti.UI.createTableView({backgroundColor:"#00ffffff",layout:"vertical",top:"70dp",bottom:"5dp",footerView:n.__views.is.getProxyPropertyEx("footerView",{recurse:!0}),id:"deals"}),n.__views.wrapper.add(n.__views.deals),d.destroy=function(){},_.extend(n,n.__views);var u=Ti.UI.createButton({titleid:"all_companies"}),y=1,p=arguments[0].subCategories||!1,b=!1;p&&(b=JSON.stringify(p));var w=arguments[0].lat,g=arguments[0].lng,v=10;distance=arguments[0].distance,u.addEventListener("click",function(){var e=new Date,t=Alloy.createController("home/companies/index",{lat:w,lng:g,distance:distance,token:Alloy.Globals.core.apiToken(),clientTimeZoneOffset:e.getTimezoneOffset(),subcategories:b}).getView();t.backButtonTitle="Back",Alloy.CFG.tabHome.open(t)}),n.window.setRightNavButton(u);var h=0,f=Alloy.Globals.indicator,m=function(){var e=1;this.next=function(){return e++,e}},A=0,S=Alloy.Collections.publicDeals,I=!0,T=new m;n.sorts.labels=[L("rating"),L("price"),L("distance"),L("dealtype")],Ti.App.addEventListener("supplierWindow:blocked",r),c["$.__views.window!close!close"]&&n.__views.window.addEventListener("close",s),c["$.__views.window!open!open"]&&n.__views.window.addEventListener("open",e),c["$.__views.sorts!click!Sort"]&&n.__views.sorts.addEventListener("click",o),c["$.__views.is!end!add"]&&n.__views.is.on("end",i),_.extend(n,d)}var Alloy=require("alloy"),Backbone=Alloy.Backbone,_=Alloy._;module.exports=Controller;